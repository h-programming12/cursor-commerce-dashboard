---
alwaysApply: false
---

아래의 조건을 모두 적용하여, 아래의 요구사항을 모두 구현할 것.
구현 결과를 체크리스트로 반환할 것.

==============================================
조건-커서룰) 아래의 커서룰을 적용하여 작업하고,
이 작업이 끝나면 해당 rules 적용 결과를 체크리스트로 반환할 것. - @01-common.mdc
==============================================

현재 단계:
Next.js 16 App Router + TypeScript 프로젝트에서 Supabase 클라이언트를 초기화하고,
타입 안전한 환경변수 관리 및 클라이언트/서버 래퍼를 구축하는 단계이다.

목표:

- Supabase 프로젝트는 이미 생성되어 있고,
  최신 키 체계인 "publishable" / "secret" API 키도 발급되어 있다고 가정한다.
- 환경변수 → 타입 안전 로더 → 클라이언트 래퍼까지 구축한다.

==============================================
[1] 패키지 설치

다음 의존성을 설치하도록 package.json을 수정하거나
설치 명령어를 제시할 것.

필수:

- @supabase/supabase-js (최신 버전)
- @supabase/ssr (Next.js App Router SSR 헬퍼)

예:

- "pnpm add @supabase/supabase-js @supabase/ssr"

설치 명령어는 코드 블록으로 정리해줄 것.

==============================================
[2] 환경변수 구조 (.env.example)

Supabase 대시보드에서 이미 발급해 둔 **최신 키 체계**를 사용한다.
(legacy anon / service_role 키는 사용하지 않는다.)

아래 환경변수를 .env.example에 정의하고,
각 값이 어떤 의미인지 주석으로 설명할 것:

- NEXT_PUBLIC_SUPABASE_URL=https://ykqzxvwvibycqdkpuaoh.supabase.co

  # Supabase Dashboard > General > Project URL

- NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY=sb_publishable_xxxxx

  # Supabase Dashboard > API > "Publishable" 키 (클라이언트용, 기존 anon 역할)

- SUPABASE_SECRET_KEY=sb_secret_xxxxx

  # Supabase Dashboard > API > "Secret" 키 (서버 전용, 기존 service_role 역할)

  # 절대 클라이언트로 노출 금지

- NEXT_PUBLIC_SITE_URL=http://localhost:3000
  # Auth redirect 등에 사용, 배포 시 실제 URL로 변경

요구사항:

- .env.example 상단에
  "실제 개발 시에는 .env.local 에 복사해서 값을 채운다"는 주석 추가
- secret key의 민감도를 명확하게 설명

==============================================
[3] 타입 안전 환경변수 로더 (/commons/config/env.ts)

목표:

- process.env 접근을 한 곳에서 관리
- Supabase 관련 env가 빠져 있으면 명확한 에러를 던짐
- 클라이언트/서버에서 사용할 수 있는 값을 구분

구현 요구사항:

1. 타입 정의

   - SupabaseEnv:
     - url: string
     - publishableKey: string
     - secretKey: string
   - AppEnv:
     - supabase: SupabaseEnv
     - siteUrl: string

2. 함수

   - getPublicEnv(): 클라이언트에서도 사용 가능한 값만 반환

     - supabase.url
     - supabase.publishableKey
     - siteUrl
     - secretKey는 포함하지 않음

   - getServerEnv(): 서버 전용 값까지 포함
     - supabase.url
     - supabase.publishableKey
     - supabase.secretKey
     - siteUrl

3. 검증

   - 각 환경변수가 없으면 명확한 에러 메시지와 함께 Error 던지기
   - production 환경에서도 동작하도록 설계

4. 주석
   - publishableKey: 브라우저에서 사용 가능한 공개 키
   - secretKey: 강력한 권한의 서버 전용 키, 절대 클라이언트 노출 금지

==============================================
[4] Supabase 클라이언트 래퍼

폴더/파일:

- /lib/supabase/client.ts (클라이언트용)
- /lib/supabase/server.ts (서버용)

(1) /lib/supabase/client.ts

- 브라우저/클라이언트에서 사용
- NEXT_PUBLIC_SUPABASE_URL, NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY 사용
- singleton 패턴으로 구현

예시 구조:
import { createClient, SupabaseClient } from "@supabase/supabase-js";
import { getPublicEnv } from "@/commons/config/env";

    let browserClient: SupabaseClient | null = null;

    export function getSupabaseBrowserClient(): SupabaseClient {
      if (!browserClient) {
        const { supabase } = getPublicEnv();
        browserClient = createClient(supabase.url, supabase.publishableKey);
      }
      return browserClient;
    }

- "나중에 DB 타입을 붙일 예정"이라는 주석 추가

(2) /lib/supabase/server.ts

- 서버(서버 액션, route handler)에서 사용
- getServerEnv()를 사용해 secretKey까지 불러옴

예시 구조:
import { createClient, SupabaseClient } from "@supabase/supabase-js";
import { getServerEnv } from "@/commons/config/env";

    let serverClient: SupabaseClient | null = null;

    export function getSupabaseServerClient(): SupabaseClient {
      if (!serverClient) {
        const { supabase } = getServerEnv();
        serverClient = createClient(supabase.url, supabase.secretKey);
      }
      return serverClient;
    }

- secretKey로 생성한 클라이언트는 **반드시 서버 코드에서만 import**하도록 큰 주석으로 경고
- Auth 연동 시 더 안전한 패턴 사용 가능하다는 TODO 주석 추가

==============================================
[5] 간단한 사용 예시

다음 사용 예시를 코드 주석으로 작성:

1. 클라이언트 컴포넌트에서 데이터 가져오기:

   - getSupabaseBrowserClient() → from("products").select("\*")

2. 서버 액션에서 데이터 생성:

   - getSupabaseServerClient() → from("orders").insert(...)

3. 나중에 Auth 연동 및 RLS 설정을 할 것이라는 TODO 주석

==============================================
최종 반환 형식

1. supabase-js 설치 명령어
2. .env.example 전체 내용
3. /commons/config/env.ts 전체 코드
4. /lib/supabase/client.ts 전체 코드
5. /lib/supabase/server.ts 전체 코드
6. 간단한 사용 예시 코드
7. 아래 체크리스트(각 항목에 대해 ✅/❌ + 간단 사유):

   - 커서룰(@01-common.mdc) 준수 여부
   - 최신 키 체계(publishable/secret) 사용 여부
   - .env.example에 Supabase 관련 키가 올바르게 정의되었는지
   - env.ts에서 public/server env를 타입 안전하게 구분하는지
   - 클라이언트/서버 Supabase 클라이언트 래퍼가 올바르게 구성되었는지
   - Next.js 15 App Router + Supabase v2 환경에서 바로 사용 가능한지
